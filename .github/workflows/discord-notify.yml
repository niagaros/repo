name: Discord notifications

on:
  push:
    branches:
      - "**"           # alle branches
  pull_request:
    types: [opened, reopened, closed, ready_for_review]
  issues:
    types: [opened, reopened, closed]
  workflow_dispatch:    # handmatig testen

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Notify Discord
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          EVENT_NAME: ${{ github.event_name }}
          ACTOR: ${{ github.actor }}
          REPO: ${{ github.repository }}
          REF: ${{ github.ref }}
          SERVER_URL: ${{ github.server_url }}
        run: |
          set -euo pipefail

          if [ -z "${DISCORD_WEBHOOK_URL:-}" ]; then
            echo "Missing DISCORD_WEBHOOK_URL secret"
            exit 1
          fi

          TITLE="GitHub: ${EVENT_NAME}"
          URL="${SERVER_URL}/${REPO}"

          if [ "${EVENT_NAME}" = "push" ]; then
            BRANCH="${REF#refs/heads/}"
            MSG="$(jq -r '.head_commit.message // "No message"' "$GITHUB_EVENT_PATH" | head -c 250)"
            COMMIT_URL="$(jq -r '.head_commit.url // empty' "$GITHUB_EVENT_PATH")"
            TITLE="Push to ${BRANCH}"
            URL="${COMMIT_URL:-$URL}"
            CONTENT="ðŸ”” **${TITLE}**\nRepo: **${REPO}**\nBy: **${ACTOR}**\nMessage: ${MSG}\n${URL}"
          elif [ "${EVENT_NAME}" = "pull_request" ]; then
            ACTION="$(jq -r '.action' "$GITHUB_EVENT_PATH")"
            NUMBER="$(jq -r '.pull_request.number' "$GITHUB_EVENT_PATH")"
            PTITLE="$(jq -r '.pull_request.title' "$GITHUB_EVENT_PATH")"
            PURL="$(jq -r '.pull_request.html_url' "$GITHUB_EVENT_PATH")"
            CONTENT="ðŸ”” **PR ${ACTION}: #${NUMBER}**\n**${PTITLE}**\nRepo: **${REPO}**\nBy: **${ACTOR}**\n${PURL}"
          elif [ "${EVENT_NAME}" = "issues" ]; then
            ACTION="$(jq -r '.action' "$GITHUB_EVENT_PATH")"
            NUMBER="$(jq -r '.issue.number' "$GITHUB_EVENT_PATH")"
            ITITLE="$(jq -r '.issue.title' "$GITHUB_EVENT_PATH")"
            IURL="$(jq -r '.issue.html_url' "$GITHUB_EVENT_PATH")"
            CONTENT="ðŸ”” **Issue ${ACTION}: #${NUMBER}**\n**${ITITLE}**\nRepo: **${REPO}**\nBy: **${ACTOR}**\n${IURL}"
          else
            CONTENT="ðŸ”” **${TITLE}**\nRepo: **${REPO}**\nBy: **${ACTOR}**\n${URL}"
          fi

          payload=$(jq -n --arg content "$CONTENT" '{content: $content}')

          curl -sS -X POST -H "Content-Type: application/json" \
            -d "$payload" "$DISCORD_WEBHOOK_URL" > /dev/null
